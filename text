import pandas as pd
import numpy as np

# Load the raw CSV created by Script 1
df = pd.read_csv("DailyStockData.csv")

# ✅ Step 1: Basic Cleaning
df.drop_duplicates(inplace=True)

# Ensure correct data types
df['TradeDate'] = pd.to_datetime(df['TradeDate'])
numeric_cols = ["OpenPrice", "HighPrice", "LowPrice", "ClosePrice", "AdjClosePrice", "TradeVolume"]
df[numeric_cols] = df[numeric_cols].apply(pd.to_numeric, errors='coerce')

# ✅ Step 2: Validation (High >= Low, etc.)
df = df[(df['HighPrice'] >= df['LowPrice']) & 
        (df['ClosePrice'] <= df['HighPrice']) & 
        (df['ClosePrice'] >= df['LowPrice'])]

# ✅ Step 3: Enrichment
df.sort_values(by=["Company", "TradeDate"], inplace=True)

# Daily % Return
df['DailyReturnPct'] = df.groupby("Company")['ClosePrice'].pct_change() * 100

# Price Range (High - Low)
df['PriceRange'] = df['HighPrice'] - df['LowPrice']

# Rolling Volatility (7-day standard deviation of returns)
df['Volatility_7d'] = df.groupby("Company")['ClosePrice'].transform(lambda x: x.pct_change().rolling(7).std())

# Moving Averages
df['SMA7'] = df.groupby("Company")['ClosePrice'].transform(lambda x: x.rolling(7).mean())
df['SMA30'] = df.groupby("Company")['ClosePrice'].transform(lambda x: x.rolling(30).mean())

# Volume Moving Average
df['Vol_MA7'] = df.groupby("Company")['TradeVolume'].transform(lambda x: x.rolling(7).mean())

# Volume Spike Flag (if today's volume > 2x 7-day avg)
df['VolumeSpike'] = df['TradeVolume'] > (2 * df['Vol_MA7'])

# ✅ Step 4: Date Dimensions
df['Year'] = df['TradeDate'].dt.year
df['Month'] = df['TradeDate'].dt.month
df['Weekday'] = df['TradeDate'].dt.day_name()

# ✅ Step 5: Save enriched dataset
df.to_csv("EnrichedStockData.csv", index=False)
print("✅ Enriched dataset saved as EnrichedStockData.csv")
print(df.head(10))
